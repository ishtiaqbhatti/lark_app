import{r as w,ah as K,ag as z,af as q,av as D,aG as U,aj as t,au as O,ak as V,aC as B,al as Y,aH as G,aI as $,Z as m,as as H,aJ as E,ao as _,ar as F,aK as Z}from"./index-igZMX4Bp.js";import{g as X,a as ee}from"./opportunitiesService-C8Ai8DUW.js";import{u as te}from"./useClient-BASY--XD.js";import{u as A}from"./useMutation-Bs8GWcgR.js";import{s as oe,r as L}from"./orchestratorService-C1VspGjv.js";import{J as re}from"./JobStatusIndicator-BYpq26Zc.js";import{R as P,a as W}from"./ExclamationCircleOutlined-Bos2PYdp.js";import{F as ae}from"./Table-CAAunq6x.js";import{M as se}from"./index-Bm9ETF0h.js";import"./progress-nMxHyNiz.js";import"./CheckCircleOutlined-DkLkWzh1.js";import"./Pagination-ZF9HoXKE.js";const ie=()=>{const{clientId:r}=te(),[d,k]=w.useState({current:1,pageSize:20,total:0}),[j,g]=w.useState("review"),[f,b]=w.useState({field:"strategic_score",order:"descend"}),[S,c]=w.useState(""),{data:s,isLoading:v,isError:T,error:i,refetch:C}=K(["opportunities",r,d.current,d.pageSize,j,f,S],()=>X(r,{page:d.current,limit:d.pageSize,status:j,sort_by:f.field,sort_direction:f.order==="ascend"?"asc":"desc",keyword:S}),{enabled:!!r,staleTime:60*1e3,onSuccess:n=>{k(R=>({...R,total:n.total_items||0}))}}),{data:y}=K(["dashboardStats",r],()=>ee(r),{enabled:!!r,staleTime:60*1e3}),x=(n,R,l)=>{k(N=>({...N,current:n.current,pageSize:n.pageSize}));const u=Array.isArray(l)?l[0]:l;u!=null&&u.field?b({field:u.field,order:u.order}):b({field:"strategic_score",order:"descend"})},I=n=>{c(n)};return{opportunities:(s==null?void 0:s.items)||[],isLoading:v,isError:T,error:i,pagination:d,handleTableChange:x,activeStatus:j,setActiveStatus:g,statusCounts:(y==null?void 0:y.status_counts)||{},handleSearch:I,refetchOpportunities:C}},ne=r=>r==null||isNaN(r)?"N/A":r.toLocaleString(),ce=r=>r==null||isNaN(r)?"N/A":`$${r.toFixed(2)}`,{Content:de}=B,{Title:le,Text:ue}=V,{confirm:Q}=se,{TabPane:pe}=E,ge=["review","paused_for_approval","generated","rejected","failed"],ye={review:"blue",paused_for_approval:"orange",generated:"green",rejected:"default",failed:"red"},_e=()=>{const{opportunities:r,isLoading:d,pagination:k,handleTableChange:j,activeStatus:g,setActiveStatus:f,statusCounts:b={},handleSearch:S}=ie(),{showNotification:c}=z(),s=q(),v=D(),{activeJobs:T}=U(),[i,C]=w.useState([]),{mutate:y,isLoading:x}=A(({opportunityId:e,override:o,opportunityKeyword:a})=>oe(e,o),{onSuccess:(e,o)=>{const{opportunityKeyword:a}=o;c("success","Workflow Started",`A new workflow has been queued for "${a}".`),s.invalidateQueries("opportunities"),s.invalidateQueries("activeJobs")},onError:(e,o)=>{const{opportunityKeyword:a}=o;c("error",`Workflow Failed for "${a}"`,e.message)}}),{mutate:I,isLoading:n}=A(e=>L(e),{onSuccess:()=>{c("success","Opportunity Rejected","The opportunity has been marked as rejected."),s.invalidateQueries("opportunities"),s.invalidateQueries("dashboardStats")},onError:e=>c("error","Rejection Failed",e.message)}),{mutate:R,isLoading:l}=A(e=>Promise.all(e.map(o=>L(o))),{onSuccess:()=>{c("success","Bulk Action",`${i.length} opportunities have been rejected.`),C([]),s.invalidateQueries("opportunities"),s.invalidateQueries("dashboardStats")},onError:e=>c("error","Bulk Rejection Failed",e.message)}),u=()=>{Q({title:`Are you sure you want to reject these ${i.length} opportunities?`,icon:t.jsx(W,{}),content:"This action cannot be undone.",okText:"Yes, Reject All",okType:"danger",cancelText:"No",onOk(){R(i)}})},N=e=>{Q({title:"Are you sure you want to reject this opportunity?",icon:t.jsx(W,{}),content:"This action cannot be undone.",okText:"Yes, Reject",okType:"danger",cancelText:"No",onOk(){I(e)}})},J=(e,o)=>{const a=x||n||l,h=[];switch(o.status){case"review":case"validated":h.push(t.jsx(_,{title:"Start Full Workflow",children:t.jsx(m,{type:"primary","aria-label":"Start Full Workflow",icon:t.jsx(F,{}),onClick:p=>{p.stopPropagation(),y({opportunityId:o.id,override:!1,opportunityKeyword:o.keyword})},loading:x,disabled:a})},"run"),t.jsx(_,{title:"Reject Opportunity",children:t.jsx(m,{danger:!0,"aria-label":"Reject Opportunity",icon:t.jsx(P,{}),onClick:p=>{p.stopPropagation(),N(o.id)},loading:n,disabled:a})},"reject"));break;case"rejected":case"failed":h.push(t.jsx(_,{title:"Rerun Workflow",children:t.jsx(m,{type:"primary","aria-label":"Rerun Workflow",icon:t.jsx(F,{}),onClick:p=>{p.stopPropagation(),y({opportunityId:o.id,override:!0,opportunityKeyword:o.keyword})},loading:x,disabled:a})},"run-failed"));break}return h.push(t.jsx(_,{title:"View Details",children:t.jsx(m,{"aria-label":"View Details",icon:t.jsx(Z,{}),onClick:p=>{p.stopPropagation(),v(`/opportunities/${o.id}`)}})},"view")),t.jsx($,{children:h})},M=[{title:"Keyword",dataIndex:"keyword",key:"keyword",sorter:!0,render:(e,o)=>t.jsx("a",{onClick:a=>{a.stopPropagation(),v(`/opportunities/${o.id}`)},children:e})},{title:"Search Volume",dataIndex:"search_volume",key:"search_volume",sorter:!0,render:e=>ne(e)},{title:"KD",dataIndex:"keyword_difficulty",key:"keyword_difficulty",sorter:!0,render:e=>e??"N/A"},{title:"Intent",dataIndex:"main_intent",key:"main_intent",render:e=>e?t.jsx(O,{children:e.toUpperCase()}):"N/A",hidden:g==="rejected"},{title:"Strategic Score",dataIndex:"strategic_score",key:"strategic_score",sorter:!0,render:e=>e?t.jsx("strong",{children:e.toFixed(1)}):"N/A",hidden:g==="rejected"},{title:"CPC",dataIndex:"cpc",key:"cpc",sorter:!0,render:e=>ce(e)},{title:"Rejection Reason",dataIndex:"blog_qualification_reason",key:"blog_qualification_reason",render:e=>e||t.jsx(ue,{type:"secondary",children:"No reason provided"}),hidden:g!=="rejected"},{title:"Actions",key:"actions",fixed:"right",width:120,render:(e,o)=>{const a=T.find(h=>h.id===o.latest_job_id);return a?t.jsx(re,{jobId:a.id}):J(e,o)}}].filter(e=>!e.hidden);return t.jsx(B,{style:{padding:"24px"},children:t.jsxs(de,{children:[t.jsx(le,{level:2,children:"Content Opportunities"}),t.jsx(Y,{placeholder:"Search keywords...",prefix:t.jsx(G,{}),allowClear:!0,onChange:e=>S(e.target.value),style:{width:300,marginBottom:16}}),t.jsx($,{style:{marginBottom:16},children:t.jsxs(m,{danger:!0,onClick:u,disabled:i.length===0,loading:l,icon:t.jsx(P,{}),children:["Reject Selected (",i.length,")"]})}),t.jsxs(H,{children:[t.jsx("div",{className:"custom-tabs",children:t.jsx(E,{activeKey:g,onChange:f,children:ge.map(e=>t.jsx(pe,{tab:t.jsxs("span",{children:[e.replace(/_/g," ").toUpperCase(),t.jsx(O,{color:ye[e],style:{marginLeft:8},children:b[e]||0})]})},e))})}),t.jsx(ae,{columns:M,dataSource:r,rowKey:"id",loading:d,pagination:k,onChange:j,rowSelection:{selectedRowKeys:i,onChange:C},onRow:e=>({style:{opacity:l&&i.includes(e.id)?.5:1,transition:"opacity 0.2s"}}),rowClassName:"table-row-hover"})]})]})})};export{_e as default};
